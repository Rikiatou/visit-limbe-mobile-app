format_version: "12"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: other

app:
  envs:
  - BITRISE_PROJECT_PATH: "."
  - BITRISE_EXPORT_METHOD: development

meta:
  bitrise.io:
    stack: linux-docker-android-22.04
    machine_type_id: standard

workflows:
  primary:
    description: |
      Build APK for Visit Limbe Mobile App using Capacitor
    envs:
    - GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m -XX:+HeapDumpOnOutOfMemoryError"
    - ANDROID_HOME: $ANDROID_HOME
    - JAVA_HOME: $JAVA_HOME_17_X64
    
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
        
    - git-clone@8: {}
    
    - script@1:
        title: Setup Build Environment
        inputs:
        - content: |
            #!/usr/bin/env bash
            set -ex
            
            echo "üîß Setting up build environment..."
            echo "Node.js version: $(node --version)"
            echo "npm version: $(npm --version)"
            echo "Java version: $(java -version)"
            echo "Android SDK: $ANDROID_HOME"
            
            # Create build directory if it doesn't exist
            mkdir -p build
            
    - script@1:
        title: Install Node.js Dependencies
        inputs:
        - content: |
            #!/usr/bin/env bash
            set -ex
            
            echo "üì¶ Installing dependencies..."
            npm install
            
    - script@1:
        title: Generate APK with Capacitor
        inputs:
        - content: |
            #!/usr/bin/env bash
            set -ex
            
            echo "üöÄ Starting Capacitor Android build..."
            
            # Install Capacitor dependencies locally
            npm install @capacitor/android @capacitor/cli @capacitor/core
            
            # Initialize Capacitor project with configuration
            npx cap init "Visit Limbe" "com.visitlimbe.app" --web-dir=www
            
            # Add Android platform
            npx cap add android
            
            # Ensure capacitor.config.json is properly configured
            echo "‚úÖ Capacitor configuration created"
            
            # Copy web assets to native project and sync
            npx cap copy android
            npx cap sync android
            
            # Update Android project for proper web content loading
            npx cap update android
            
            echo "üî® Building Android APK..."
            # Build Android APK
            cd android
            chmod +x ./gradlew
            ./gradlew assembleDebug --stacktrace --info
            
            # Copy APK to artifacts
            mkdir -p $BITRISE_DEPLOY_DIR
            echo "üì± Searching for APK files..."
            find . -name "*.apk" -type f
            
            # Copy the APK
            if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
                cp app/build/outputs/apk/debug/app-debug.apk $BITRISE_DEPLOY_DIR/visit-limbe-app.apk
                echo "‚úÖ APK copied successfully!"
            else
                echo "‚ùå APK not found!"
                exit 1
            fi
            
            echo "üìã Final artifacts:"
            ls -la $BITRISE_DEPLOY_DIR/
            
    - deploy-to-bitrise-io@2:
        inputs:
        - deploy_path: $BITRISE_DEPLOY_DIR
        - notify_user_groups: none

trigger_map:
- push_branch: main
  workflow: primary
- pull_request_source_branch: "*"
  workflow: primary